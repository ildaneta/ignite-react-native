{"version":3,"file":"plugin-resolver.js","sourceRoot":"","sources":["../../src/utils/plugin-resolver.ts"],"names":[],"mappings":"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","sourcesContent":["import assert from 'assert';\nimport findUp from 'find-up';\nimport * as path from 'path';\nimport resolveFrom from 'resolve-from';\n\nimport { ConfigPlugin, StaticPlugin } from '../Plugin.types';\nimport { PluginError } from './errors';\nimport { fileExists } from './modules';\n\n// Default plugin entry file name.\nexport const pluginFileName = 'app.plugin.js';\n\nfunction findUpPackageJson(root: string): string {\n  const packageJson = findUp.sync('package.json', { cwd: root });\n  assert(packageJson, `No package.json found for module \"${root}\"`);\n  return packageJson;\n}\n\nexport function resolvePluginForModule(projectRoot: string, modulePath: string) {\n  const resolved = resolveFrom.silent(projectRoot, modulePath);\n  if (!resolved) {\n    throw new PluginError(\n      `Failed to resolve plugin for module \"${modulePath}\" relative to \"${projectRoot}\"`,\n      'PLUGIN_NOT_FOUND'\n    );\n  }\n  // If the modulePath is something like `@bacon/package/index.js` or `expo-foo/build/app`\n  // then skip resolving the module `app.plugin.js`\n  if (moduleNameIsDirectFileReference(modulePath)) {\n    return { isPluginFile: false, filePath: resolved };\n  }\n  return findUpPlugin(resolved);\n}\n\n// TODO: Test windows\nfunction pathIsFilePath(name: string): boolean {\n  // Matches lines starting with: . / ~/\n  return !!name.match(/^(\\.|~\\/|\\/)/g);\n}\n\nexport function moduleNameIsDirectFileReference(name: string): boolean {\n  if (pathIsFilePath(name)) {\n    return true;\n  }\n\n  const slashCount = name.split(path.sep)?.length;\n  // Orgs (like @expo/config ) should have more than one slash to be a direct file.\n  if (name.startsWith('@')) {\n    return slashCount > 2;\n  }\n\n  // Regular packages should be considered direct reference if they have more than one slash.\n  return slashCount > 1;\n}\n\nfunction resolveExpoPluginFile(root: string): string | null {\n  // Find the expo plugin root file\n  const pluginModuleFile = resolveFrom.silent(\n    root,\n    // use ./ so it isn't resolved as a node module\n    `./${pluginFileName}`\n  );\n\n  // If the default expo plugin file exists use it.\n  if (pluginModuleFile && fileExists(pluginModuleFile)) {\n    return pluginModuleFile;\n  }\n  return null;\n}\n\nfunction findUpPlugin(root: string): { filePath: string; isPluginFile: boolean } {\n  // Get the closest package.json to the node module\n  const packageJson = findUpPackageJson(root);\n  // resolve the root folder for the node module\n  const moduleRoot = path.dirname(packageJson);\n  // use whatever the initial resolved file was ex: `node_modules/my-package/index.js` or `./something.js`\n  const pluginFile = resolveExpoPluginFile(moduleRoot);\n  return { filePath: pluginFile ?? root, isPluginFile: !!pluginFile };\n}\n\nexport function normalizeStaticPlugin(plugin: StaticPlugin | ConfigPlugin | string): StaticPlugin {\n  if (Array.isArray(plugin)) {\n    assert(\n      plugin.length > 0 && plugin.length < 3,\n      `Wrong number of arguments provided for static config plugin, expected either 1 or 2, got ${plugin.length}`\n    );\n    return plugin;\n  }\n  return [plugin, undefined];\n}\n\nexport function assertInternalProjectRoot(projectRoot?: string): asserts projectRoot {\n  assert(\n    projectRoot,\n    `Unexpected: Config \\`_internal.projectRoot\\` isn't defined by expo-cli, this is a bug.`\n  );\n}\n\n// Resolve the module function and assert type\nexport function resolveConfigPluginFunction(projectRoot: string, pluginReference: string) {\n  const { plugin } = resolveConfigPluginFunctionWithInfo(projectRoot, pluginReference);\n  return plugin;\n}\n\n// Resolve the module function and assert type\nexport function resolveConfigPluginFunctionWithInfo(projectRoot: string, pluginReference: string) {\n  const { filePath: pluginFile, isPluginFile } = resolvePluginForModule(\n    projectRoot,\n    pluginReference\n  );\n  let result: any;\n  try {\n    result = requirePluginFile(pluginFile);\n  } catch (error) {\n    if (error instanceof SyntaxError) {\n      const learnMoreLink = `Learn more: https://docs.expo.io/guides/config-plugins/#creating-a-plugin`;\n      // If the plugin reference is a node module, and that node module has a syntax error, then it probably doesn't have an official config plugin.\n      if (!isPluginFile && !moduleNameIsDirectFileReference(pluginReference)) {\n        const pluginError = new PluginError(\n          `Package \"${pluginReference}\" does not contain a valid config plugin.\\n${learnMoreLink}\\n\\n${error.message}`,\n          'INVALID_PLUGIN_IMPORT'\n        );\n        pluginError.stack = error.stack;\n        throw pluginError;\n      }\n    }\n    throw error;\n  }\n\n  const plugin = resolveConfigPluginExport({\n    plugin: result,\n    pluginFile,\n    pluginReference,\n    isPluginFile,\n  });\n  return { plugin, pluginFile, pluginReference, isPluginFile };\n}\n\n/**\n * - Resolve the exported contents of an Expo config (be it default or module.exports)\n * - Assert no promise exports\n * - Return config type\n * - Serialize config\n *\n * @param props.plugin plugin results\n * @param props.pluginFile plugin file path\n * @param props.pluginReference the string used to reference the plugin\n * @param props.isPluginFile is file path from the app.plugin.js module root\n */\nexport function resolveConfigPluginExport({\n  plugin,\n  pluginFile,\n  pluginReference,\n  isPluginFile,\n}: {\n  plugin: any;\n  pluginFile: string;\n  pluginReference: string;\n  isPluginFile: boolean;\n}): ConfigPlugin<unknown> {\n  if (plugin.default != null) {\n    plugin = plugin.default;\n  }\n  if (typeof plugin !== 'function') {\n    const learnMoreLink = `Learn more: https://docs.expo.io/guides/config-plugins/#creating-a-plugin`;\n    // If the plugin reference is a node module, and that node module does not export a function then it probably doesn't have a config plugin.\n    if (!isPluginFile && !moduleNameIsDirectFileReference(pluginReference)) {\n      throw new PluginError(\n        `Package \"${pluginReference}\" does not contain a valid config plugin. Module must export a function from file: ${pluginFile}\\n${learnMoreLink}`,\n        'INVALID_PLUGIN_TYPE'\n      );\n    }\n    throw new PluginError(\n      `Plugin \"${pluginReference}\" must export a function from file: ${pluginFile}. ${learnMoreLink}`,\n      'INVALID_PLUGIN_TYPE'\n    );\n  }\n\n  return plugin;\n}\n\nfunction requirePluginFile(filePath: string): any {\n  try {\n    return require(filePath);\n  } catch (error) {\n    // TODO: Improve error messages\n    throw error;\n  }\n}\n"]}